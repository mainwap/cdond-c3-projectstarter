---

  environment:
    TYPEORM_CONNECTION: "{{ lookup('env', 'TYPEORM_CONNECTION') }}"
    TYPEORM_ENTITIES: "{{ lookup('env', 'TYPEORM_ENTITIES') }}"
    TYPEORM_Hosts: "{{ lookup('env', 'TYPEORM_HOST') }}"
    TYPEORM_PORT: 5432
    TYPEORM_USERNAME: "{{ lookup('env', 'TYPEORM_USERNAME') }}"
    TYPEORM_PASSWORD: "{{ lookup('env', 'TYPEORM_PASSWORD') }}"
    TYPEORM_DATABASE: "{{ lookup('env', 'TYPEORM_DATABASE') }}"
    TYPEORM_MIGRATIONS: "{{ lookup('env', 'TYPEORM_MIGTRATIONS') }}"
    TYPEFORM_MIGRATIONS_DIR: "{{ lookup('env', 'TYPEORM_MIGTRATIONS_DIR') }}"

#- name: check vars
  #shell: |    
    #echo {$TYPEORM_CONNECTION $TYPEORM_ENTITIES $TYPEORM_Hosts $TYPEORM_PORT $TYPEORM_USERNAME $TYPEORM_PASSWORD $TYPEORM_DATABASE $TYPEORM_MIGRATIONS $TYPEORM_MIGRATIONS_DIR}
  #register: set_vars  

- name: create web directory
  file:
    path: ~/backend_app
    state: directory

- name: "wait 600 seconds for target connection to become reachable/usable."
  ansible.builtin.wait_for_connection:
  timeout: 900
- name: Copy backend compressed file 
  #become: true
  copy:
    src: /home/circleci/project/artifact.tar.gz
    dest: ~/backend_app
- name: Extract backend files
  # become: true
  shell: |
    cd ~/backend_app
    tar -vxf artifact.tar.gz
    #rm artifact.tar.gz
    ls
  register: output


- debug:
    var: output

- name : Compile and start app 
  # become : true 
  shell : | 
    cd ~/backend_app
    npm install
    
    pm2 stop default
    pm2 start npm -- start